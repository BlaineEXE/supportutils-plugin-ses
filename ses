#!/bin/bash
#############################################################
# Name:        Supportconfig Plugin for SUSE Enterprise Storage
# Description: Gathers important troubleshooting information
#              about SUSE Enterprise Storage
# License:     GPLv2
# Author:      Tim Serong <tserong@suse.com>
# Modified:    2015-02-13
#############################################################

SVER=1.0.0
RCFILE="/usr/lib/supportconfig/resources/scplugin.rc"
export SES_RESOURCES_DIR=${SES_RESOURCES_DIR:-"/usr/lib/supportconfig/resources/ses/"} # override only for development
export LOG_LINES=5000  # 0 means include the entire file
export CENSORED='<<CENSORED BY SUPPORTCONFIG PLUGIN>>'

[ -s $RCFILE ] && . $RCFILE || { echo "ERROR: Initializing resource file: $RCFILE"; exit 1; }

source "$SES_RESOURCES_DIR"/helpers.sh

#############################################################
# TUNABLES

export OPTION_SES_BACKEND="${OPTION_SES_BACKEND:-cephadm}"

export OPTION_SES_INACTIVE_PG_QUERY_MAX="${OPTION_SES_INACTIVE_PG_QUERY_MAX:-20}"
export OPTION_SES_RBD_INFO_MAX="${OPTION_SES_RBD_INFO_MAX:-10}"

# Tunables specifically for OPTION_SES_BACKEND="cephadm"

# Tunables specifically for OPTION_SES_BACKEND="rook" (not yet supported)


#############################################################
section_header "Supportconfig Plugin for SUSE Enterprise Storage, v${SVER}"

# This top-level script is mostly an entrypoint which takes user inputs and calls out to the
# necessary resources to collect logs based on that input
case $OPTION_SES_BACKEND in
cephadm)
    plugin_message "SES backend: cephadm"
    plugin_message "" # newline
    source "$SES_RESOURCES_DIR"/cephadm
    ;;
rook)
    print_error "SES backend '$OPTION_SES_BACKEND' is known but not yet supported"
    exit 1
    ;;
*)
    print_error "SES backend '$OPTION_SES_BACKEND' is not known or supported"
    exit 1
    ;;
esac
