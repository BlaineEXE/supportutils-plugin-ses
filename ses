#!/bin/bash
#############################################################
# Name:        Supportconfig Plugin for SUSE Enterprise Storage
# Description: Gathers important troubleshooting information
#              about SUSE Enterprise Storage
# License:     GPLv2
# Author:      Tim Serong <tserong@suse.com>
# Modified:    2015-02-13
#############################################################

SVER=1.0.0
RCFILE="/usr/lib/supportconfig/resources/scplugin.rc"
export SES_RESOURCES_DIR=${SES_RESOURCES_DIR:-"/usr/lib/supportconfig/resources/ses/"} # override only for development
export LOG_LINES=5000  # 0 means include the entire file
export CENSORED='<<CENSORED BY SUPPORTCONFIG PLUGIN>>'

[ -s $RCFILE ] && . $RCFILE || { echo "ERROR: Initializing resource file: $RCFILE"; exit 1; }

source "$SES_RESOURCES_DIR"/helpers.sh

# base log dir for all logs from the SES supportutils plugin
export CEPHLOG="$LOG"/ceph
mkdir --parents "$CEPHLOG"

# log dir for all Ceph daemon-specific information
export DAEMONLOG="$CEPHLOG"/daemon
mkdir "$DAEMONLOG"


#############################################################
# TUNABLES
# User-facing tunables should be of the form OPTION_SES_
# and should have a default value set.
# Internal variables can be named differently. Example below:
#   export INTERNAL_VAR="${OPTION_SES_USER_OPTION:-default}"

export SES_BACKEND="${OPTION_SES_BACKEND:-cephadm}"

export INACTIVE_PG_QUERY_MAX="${OPTION_SES_INACTIVE_PG_QUERY_MAX:-20}"
export RBD_INFO_MAX="${OPTION_SES_RBD_INFO_MAX:-10}"
export CT=${OPTION_SES_CEPH_CONNECT_TIMEOUT_SECONDS:-5}

# Tunables specifically for OPTION_SES_BACKEND="cephadm"

# Tunables specifically for OPTION_SES_BACKEND="rook" (not yet supported)
export KUBECTL="${OPTION_SES_KUBECTL_CMD:-kubectl}"
export ROOK_NAMESPACE="${OPTION_SES_ROOK_NAMESPACE:-rook-ceph}"


#############################################################
export CEPH="ceph --connect-timeout=$CT"


#############################################################
section_header "Supportconfig Plugin for SUSE Enterprise Storage, v${SVER}"

# This top-level script is mostly an entrypoint which takes user inputs and calls out to the
# necessary resources to collect logs based on that input
case $SES_BACKEND in
cephadm)
    plugin_message "SES backend: cephadm"
    plugin_message "" # newline
    source "$SES_RESOURCES_DIR"/cephadm
    ;;
rook)
    plugin_message "SES backend: rook"
    plugin_message "" # newline
    source "$SES_RESOURCES_DIR"/rook
    exit 1
    ;;
*)
    print_error "SES backend '$SES_BACKEND' is not known or supported"
    exit 1
    ;;
esac
